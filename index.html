<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1976d2">
    
    <!-- PWA Meta Tags -->
    <title>TRON Wallet PWA</title>
    <meta name="description" content="Connect to multiple TRON wallets - TronLink, WalletConnect, Ledger and more">
    <link rel="manifest" id="manifest-placeholder">
    
    <!-- Icons for PWA -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FF073A'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FF073A'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- TronWeb for blockchain interactions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tronweb/5.3.2/TronWeb.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF073A, #FF4569);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .wallet-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .wallet-card:hover {
            border-color: #FF073A;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255,7,58,0.2);
        }

        .wallet-card.connected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .wallet-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: #FF073A;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .wallet-card.connected .wallet-icon {
            background: #4CAF50;
        }

        .wallet-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .wallet-status {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .wallet-card.connected .wallet-status {
            color: #4CAF50;
        }

        .btn {
            background: #FF073A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .btn:hover {
            background: #e0062e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,7,58,0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.disconnect {
            background: #6c757d;
        }

        .btn.disconnect:hover {
            background: #5a6268;
        }

        .info-panel {
            background: linear-gradient(135deg, #f8f9ff, #e8f5e8);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 1px solid #e0e0e0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #333;
        }

        .info-value {
            color: #666;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            max-width: 60%;
            text-align: right;
        }

        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c8e6c9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #FF073A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #FF073A;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .install-prompt:hover {
            transform: translateY(-2px);
        }

        .network-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .wallet-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .info-value {
                max-width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // PWA Installation Logic
        let deferredPrompt;
        
        // Mock Wallet Adapters (in real implementation, you'd use the actual npm packages)
        class BaseAdapter {
            constructor(name, icon) {
                this.name = name;
                this.icon = icon;
                this.connected = false;
                this.address = null;
                this.balance = null;
                this.network = 'Mainnet';
            }

            async connect() {
                // Simulate connection delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Check if wallet is available
                if (this.name === 'TronLink' && !window.tronWeb) {
                    throw new Error(`${this.name} wallet is not installed. Please install it from the official website.`);
                }
                
                if (this.name === 'TronLink' && window.tronWeb) {
                    // Real TronLink integration
                    try {
                        const accounts = await window.tronWeb.request({
                            method: 'tron_requestAccounts'
                        });
                        
                        if (accounts && accounts.length > 0) {
                            this.connected = true;
                            this.address = accounts[0];
                            
                            // Get balance
                            try {
                                const balance = await window.tronWeb.trx.getBalance(this.address);
                                this.balance = (balance / 1000000).toFixed(6) + ' TRX'; // Convert from SUN to TRX
                            } catch (e) {
                                this.balance = 'Unable to fetch';
                            }
                            
                            return this.address;
                        } else {
                            throw new Error('No accounts found');
                        }
                    } catch (error) {
                        throw new Error(`Failed to connect to ${this.name}: ${error.message}`);
                    }
                } else {
                    // Mock connection for other wallets
                    this.connected = true;
                    this.address = this.generateMockAddress();
                    this.balance = (Math.random() * 1000).toFixed(6) + ' TRX';
                    return this.address;
                }
            }

            async disconnect() {
                this.connected = false;
                this.address = null;
                this.balance = null;
            }

            async signMessage(message) {
                if (!this.connected) {
                    throw new Error('Wallet not connected');
                }
                
                if (this.name === 'TronLink' && window.tronWeb) {
                    try {
                        const signature = await window.tronWeb.trx.sign(message);
                        return signature;
                    } catch (error) {
                        throw new Error(`Failed to sign message: ${error.message}`);
                    }
                }
                
                // Mock signature for other wallets
                await new Promise(resolve => setTimeout(resolve, 1000));
                return `mock_signature_${Date.now()}_${this.name}`;
            }

            generateMockAddress() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890';
                let result = 'T';
                for (let i = 0; i < 33; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
        }

        // Wallet Configurations
        const walletConfigs = [
            { name: 'TronLink', icon: 'TL', deepLink: 'tronlink://connect', installUrl: 'https://www.tronlink.org/' },
            { name: 'WalletConnect', icon: 'WC', deepLink: 'wc://connect', installUrl: 'https://walletconnect.org/' },
            { name: 'TokenPocket', icon: 'TP', deepLink: 'tokenpocket://connect', installUrl: 'https://www.tokenpocket.pro/' },
            { name: 'Klever', icon: 'KL', deepLink: 'klever://connect', installUrl: 'https://klever.io/' },
            { name: 'Trust Wallet', icon: 'TW', deepLink: 'trust://wallet_connect', installUrl: 'https://trustwallet.com/' },
            { name: 'Ledger', icon: 'LD', deepLink: null, installUrl: 'https://www.ledger.com/' },
            { name: 'BitGet', icon: 'BG', deepLink: 'bitkeep://connect', installUrl: 'https://web3.bitget.com/' },
            { name: 'OKX Wallet', icon: 'OX', deepLink: 'okex://connect', installUrl: 'https://www.okx.com/web3' }
        ];

        // Main App Component
        const TronWalletPWA = () => {
            const [wallets, setWallets] = React.useState([]);
            const [selectedWallet, setSelectedWallet] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [networkStatus, setNetworkStatus] = React.useState('Online');

            // Initialize wallets
            React.useEffect(() => {
                const initializedWallets = walletConfigs.map(config => 
                    new BaseAdapter(config.name, config.icon)
                );
                setWallets(initializedWallets);

                // Check network status
                const checkNetwork = () => {
                    setNetworkStatus(navigator.onLine ? 'Online' : 'Offline');
                };

                window.addEventListener('online', checkNetwork);
                window.addEventListener('offline', checkNetwork);

                return () => {
                    window.removeEventListener('online', checkNetwork);
                    window.removeEventListener('offline', checkNetwork);
                };
            }, []);

            const connectWallet = async (walletName) => {
                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    const wallet = wallets.find(w => w.name === walletName);
                    if (!wallet) {
                        throw new Error('Wallet not found');
                    }

                    // Try deep link first for mobile
                    const config = walletConfigs.find(c => c.name === walletName);
                    if (config.deepLink && /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        try {
                            window.location.href = config.deepLink;
                            // Wait a moment to see if the app opens
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } catch (e) {
                            console.log('Deep link failed, trying direct connection');
                        }
                    }

                    const address = await wallet.connect();
                    setSelectedWallet(wallet);
                    setSuccess(`Successfully connected to ${walletName}!`);
                    
                    // Update the wallets array
                    setWallets(prev => prev.map(w => w.name === walletName ? wallet : w));

                } catch (err) {
                    setError(err.message);
                    console.error('Connection error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const disconnectWallet = async () => {
                if (!selectedWallet) return;

                setLoading(true);
                try {
                    await selectedWallet.disconnect();
                    setWallets(prev => prev.map(w => 
                        w.name === selectedWallet.name 
                            ? { ...w, connected: false, address: null, balance: null }
                            : w
                    ));
                    setSelectedWallet(null);
                    setSuccess('Wallet disconnected successfully!');
                } catch (err) {
                    setError(`Failed to disconnect: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const signTestMessage = async () => {
                if (!selectedWallet) {
                    setError('No wallet connected');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const message = `Hello TRON! Timestamp: ${Date.now()}`;
                    const signature = await selectedWallet.signMessage(message);
                    setSuccess(`Message signed successfully! Signature: ${signature.substring(0, 32)}...`);
                } catch (err) {
                    setError(`Failed to sign message: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const getWalletApp = (walletName) => {
                const config = walletConfigs.find(c => c.name === walletName);
                if (config && config.installUrl) {
                    window.open(config.installUrl, '_blank');
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>🚀 TRON Wallet PWA</h1>
                        <p>Connect to multiple TRON wallets with unified interface</p>
                    </div>

                    <div className="content">
                        <div className="network-status">
                            <strong>Network Status:</strong> {networkStatus}
                            {networkStatus === 'Offline' && ' (Some features may be limited)'}
                        </div>

                        {error && <div className="error">❌ {error}</div>}
                        {success && <div className="success">✅ {success}</div>}

                        <div className="wallet-grid">
                            {wallets.map((wallet) => (
                                <div 
                                    key={wallet.name}
                                    className={`wallet-card ${wallet.connected ? 'connected' : ''}`}
                                    onClick={() => !wallet.connected && !loading && connectWallet(wallet.name)}
                                >
                                    <div className="wallet-icon">
                                        {wallet.icon}
                                    </div>
                                    <div className="wallet-name">{wallet.name}</div>
                                    <div className="wallet-status">
                                        {wallet.connected ? '✅ Connected' : '⭕ Not Connected'}
                                    </div>
                                    {wallet.connected ? (
                                        <button 
                                            className="btn disconnect" 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                disconnectWallet();
                                            }}
                                            disabled={loading}
                                        >
                                            {loading && selectedWallet?.name === wallet.name ? 
                                                <><span className="loading"></span>Disconnecting...</> : 
                                                'Disconnect'
                                            }
                                        </button>
                                    ) : (
                                        <button 
                                            className="btn" 
                                            disabled={loading}
                                            onClick={(e) => e.stopPropagation()}
                                        >
                                            {loading ? <><span className="loading"></span>Connecting...</> : 'Connect'}
                                        </button>
                                    )}
                                    {!wallet.connected && (
                                        <button 
                                            className="btn"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                getWalletApp(wallet.name);
                                            }}
                                            style={{marginTop: '10px', fontSize: '0.9em', padding: '8px 16px'}}
                                        >
                                            Get {wallet.name}
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>

                        {selectedWallet && selectedWallet.connected && (
                            <div className="info-panel">
                                <h3 style={{marginBottom: '20px', textAlign: 'center'}}>
                                    Wallet Information - {selectedWallet.name}
                                </h3>
                                <div className="info-row">
                                    <span className="info-label">Address:</span>
                                    <span className="info-value">{selectedWallet.address}</span>
                                </div>
                                <div className="info-row">
                                    <span className="info-label">Balance:</span>
                                    <span className="info-value">{selectedWallet.balance || 'Loading...'}</span>
                                </div>
                                <div className="info-row">
                                    <span className="info-label">Network:</span>
                                    <span className="info-value">{selectedWallet.network}</span>
                                </div>
                                <div className="info-row">
                                    <span className="info-label">Status:</span>
                                    <span className="info-value" style={{color: '#4CAF50'}}>Connected ✅</span>
                                </div>
                            </div>
                        )}

                        <div className="actions">
                            <button 
                                className="btn" 
                                onClick={signTestMessage}
                                disabled={!selectedWallet?.connected || loading}
                            >
                                {loading ? <><span className="loading"></span>Signing...</> : '📝 Sign Test Message'}
                            </button>
                            
                            <button 
                                className="btn" 
                                onClick={disconnectWallet}
                                disabled={!selectedWallet?.connected || loading}
                            >
                                🔌 Disconnect All
                            </button>
                        </div>

                        <div style={{textAlign: 'center', marginTop: '40px', color: '#666'}}>
                            <p>📱 This PWA works offline and can be installed on your device!</p>
                            <p style={{marginTop: '10px', fontSize: '0.9em'}}>
                                Supported Wallets: TronLink, WalletConnect, TokenPocket, Klever, Trust Wallet, Ledger, BitGet, OKX
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'tron-wallet-pwa-v1';
                const urlsToCache = [
                    '/',
                    '/index.html',
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                });
            `;
            
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Manifest
        const manifest = {
            name: "TRON Wallet PWA",
            short_name: "TronWallet",
            description: "Connect to multiple TRON wallets",
            start_url: "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#FF073A",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FF073A'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FF073A'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestUrl;

        // PWA Install Prompt
        const InstallPrompt = () => {
            const [showInstall, setShowInstall] = React.useState(false);

            React.useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    setShowInstall(true);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);

            const handleInstall = async () => {
                if (!deferredPrompt) return;

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    setShowInstall(false);
                }
                deferredPrompt = null;
            };

            if (!showInstall) return null;

            return (
                <div className="install-prompt" onClick={handleInstall}>
                    📱 Install App
                </div>
            );
        };

        // Render the app
        const App = () => (
            <>
                <TronWalletPWA />
                <InstallPrompt />
            </>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
