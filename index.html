<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRON Wallet PWA - Real Integration</title>
<link rel="manifest" id="manifest-placeholder">
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tronweb/5.3.2/TronWeb.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin:0; padding:20px; }
  .container { max-width:800px; margin:0 auto; background:white; border-radius:15px; padding:30px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
  .wallet-card { border:1px solid #ccc; border-radius:10px; padding:20px; margin-bottom:20px; cursor:pointer; transition:0.3s; }
  .wallet-card.connected { border-color:#4CAF50; background:#e8f5e8; }
  .wallet-card.connecting { border-color:#FF9800; background:#fff3e0; }
  .btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; }
  .btn.disconnect { background:#6c757d; color:white; }
  .btn.connecting { background:#FF9800; color:white; }
  .success { color:#2e7d2e; background:#e8f5e8; padding:10px; border-radius:5px; margin-bottom:10px; }
  .error { color:#c62828; background:#ffebee; padding:10px; border-radius:5px; margin-bottom:10px; }
  .loading { display:inline-block; width:15px; height:15px; border:2px solid #f3f3f3; border-top:2px solid #FF073A; border-radius:50%; animation:spin 1s linear infinite; margin-right:5px; }
  @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

// ------------------ Real TronLink Adapter ------------------
class RealTronLinkAdapter {
    constructor() {
        this.name = 'TronLink';
        this.icon = 'TL';
        this.connected = false;
        this.address = null;
        this.balance = null;
        this.network = null;
        this.connecting = false;
        this.debugLog = [];
    }

    log(message) {
        const timestamp = new Date().toLocaleTimeString();
        this.debugLog.push(`[${timestamp}] ${message}`);
        console.log(`TronLink Adapter: ${message}`);
    }

    async connect() {
        if (this.connecting) throw new Error('Connection already in progress');
        this.connecting = true;
        this.log('Starting connection process...');
        try {
            // Wait for TronWeb to be injected
            const maxAttempts = 20;
            for (let i = 0; i < maxAttempts; i++) {
                if (window.tronWeb && window.tronWeb.ready && window.tronWeb.defaultAddress.base58) {
                    return await this.handleTronWebConnection();
                }
                await new Promise(res => setTimeout(res, 500));
            }
            throw new Error('TronWeb not detected. Please open TronLink and refresh.');
        } finally {
            this.connecting = false;
        }
    }

    async handleTronWebConnection() {
        this.address = window.tronWeb.defaultAddress.base58;
        this.log(`Address obtained: ${this.address}`);

        try {
            const nodeInfo = await window.tronWeb.trx.getNodeInfo();
            this.network = nodeInfo.configNodeInfo?.codeVersion || 'Mainnet';
        } catch {
            this.network = 'Mainnet (assumed)';
        }

        try {
            const balance = await window.tronWeb.trx.getBalance(this.address);
            this.balance = (balance / 1_000_000).toFixed(6) + ' TRX';
        } catch {
            this.balance = 'Unable to fetch';
        }

        this.connected = true;
        this.log('Connection successful!');
        return this.address;
    }

    async disconnect() {
        this.connected = false;
        this.address = null;
        this.balance = null;
        this.network = null;
        this.log('Disconnected successfully');
    }

    async signMessage(message) {
        if (!this.connected) throw new Error('Wallet not connected');
        if (!window.tronWeb || !window.tronWeb.trx.signMessage) {
            throw new Error('Signing not supported');
        }
        const signed = await window.tronWeb.trx.signMessage(message);
        this.log(`Message signed: ${signed}`);
        return signed;
    }

    async sendTRX(to, amount) {
        if (!this.connected) throw new Error('Wallet not connected');
        const tx = await window.tronWeb.trx.sendTransaction(to, amount * 1_000_000);
        this.log(`TRX sent! TXID: ${tx.txid}`);
        return tx.txid;
    }

    async sendTRC20(contractAddress, to, amount, decimals=6) {
        if (!this.connected) throw new Error('Wallet not connected');
        const contract = await window.tronWeb.contract().at(contractAddress);
        const tx = await contract.transfer(to, amount * 10**decimals).send();
        this.log(`TRC20 sent! TXID: ${tx}`);
        return tx;
    }

    async refreshBalance() {
        if (!this.connected) return;
        const balance = await window.tronWeb.trx.getBalance(this.address);
        this.balance = (balance / 1_000_000).toFixed(6) + ' TRX';
        this.log(`Balance updated: ${this.balance}`);
    }

    getDebugInfo() {
        return {
            tronWebAvailable: !!window.tronWeb,
            defaultAddress: window.tronWeb?.defaultAddress?.base58 || 'None',
            ready: window.tronWeb?.ready || false,
            logs: this.debugLog.slice(-10)
        };
    }
}

// ------------------ React PWA Component ------------------
const TronWalletPWA = () => {
    const [wallets, setWallets] = React.useState([]);
    const [selectedWallet, setSelectedWallet] = React.useState(null);
    const [loading, setLoading] = React.useState(false);
    const [error, setError] = React.useState('');
    const [success, setSuccess] = React.useState('');
    const [showDebug, setShowDebug] = React.useState(false);

    React.useEffect(() => {
        const walletList = [ new RealTronLinkAdapter() ];
        setWallets(walletList);
    }, []);

    const connectWallet = async (walletName) => {
        if (loading) return;
        setLoading(true); setError(''); setSuccess('');
        try {
            const wallet = wallets.find(w => w.name === walletName);
            if (!wallet) throw new Error('Wallet not found');
            wallet.connecting = true; setWallets([...wallets]);
            const address = await wallet.connect();
            setSelectedWallet(wallet);
            setSuccess(`Connected! Address: ${address.substring(0,10)}...`);
            setWallets(prev => prev.map(w => w.name === walletName ? {...wallet, connecting:false} : {...w, connecting:false}));
        } catch (err) {
            setError(`Connection failed: ${err.message}`);
            setWallets(prev => prev.map(w => ({...w, connecting:false})));
        } finally {
            setLoading(false);
        }
    };

    const disconnectWallet = async () => {
        if (!selectedWallet || loading) return;
        setLoading(true);
        try {
            await selectedWallet.disconnect();
            setSelectedWallet(null);
            setSuccess('Wallet disconnected');
        } catch(err) { setError(err.message); }
        finally { setLoading(false); }
    };

    const signTestMessage = async () => {
        if (!selectedWallet || loading) return;
        setLoading(true); setError('');
        try {
            const message = `Hello TRON! Test signature at ${new Date().toISOString()}`;
            const signature = await selectedWallet.signMessage(message);
            setSuccess(`Message signed! ${signature.substring(0,32)}...`);
        } catch(err) { setError(err.message); }
        finally { setLoading(false); }
    };

    const getWalletStatusClass = wallet => wallet.connecting ? 'connecting' : wallet.connected ? 'connected' : '';
    const getWalletStatusText = wallet => wallet.connecting ? 'üîÑ Connecting...' : wallet.connected ? '‚úÖ Connected' : '‚≠ï Not Connected';

    return (
        <div className="container">
            {error && <div className="error">{error}</div>}
            {success && <div className="success">{success}</div>}

            {wallets.map(wallet => (
                <div key={wallet.name} className={`wallet-card ${getWalletStatusClass(wallet)}`}>
                    <div><strong>{wallet.name}</strong></div>
                    <div>Status: {getWalletStatusText(wallet)}</div>
                    {wallet.connected && <div>Address: {wallet.address}<br/>Balance: {wallet.balance}<br/>Network: {wallet.network}</div>}
                    <button 
                        className={`btn ${wallet.connected?'disconnect':wallet.connecting?'connecting':''}`} 
                        onClick={() => wallet.connected ? disconnectWallet() : connectWallet(wallet.name)}
                        disabled={loading || wallet.connecting}>
                        {wallet.connecting ? <span className="loading"></span>Connecting... : wallet.connected ? 'Disconnect' : 'Connect'}
                    </button>
                </div>
            ))}

            {selectedWallet && selectedWallet.connected && (
                <div>
                    <button className="btn" onClick={signTestMessage} disabled={loading}>
                        {loading ? <span className="loading"></span>Signing... : 'üìù Sign Test Message'}
                    </button>
                    <button className="btn" onClick={async () => {
                        const to = prompt('Enter recipient TRX address:');
                        const amt = parseFloat(prompt('Amount in TRX:'));
                        if(to && amt) {
                            setLoading(true); setError(''); setSuccess('');
                            try {
                                const txid = await selectedWallet.sendTRX(to, amt);
                                setSuccess(`TRX sent! TXID: ${txid}`);
                                await selectedWallet.refreshBalance();
                            } catch(err) { setError(err.message); }
                            finally { setLoading(false); }
                        }
                    }}>üí∏ Send TRX</button>
                </div>
            )}

            <div>
                <button className="btn" onClick={() => setShowDebug(!showDebug)}>üêõ {showDebug ? 'Hide' : 'Show'} Debug Info</button>
                {showDebug && selectedWallet && (
                    <pre>{JSON.stringify(selectedWallet.getDebugInfo(), null, 2)}</pre>
                )}
            </div>
        </div>
    );
};

// Render App
ReactDOM.render(<TronWalletPWA />, document.getElementById('root'));

</script>
</body>
</html>
